//**************************************************************
//Unicorn activation patcher by GeoSn0w (@FCE365)
//For Educational Purpose Only!
//This was built to practice macOS program reverse engineering
//**************************************************************
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <sys/stat.h>
int binary_size;
int arch_type;
int number_of_archs = 0;
int getSize(char *path){
    struct stat buffer;
    stat(path, &buffer);
    return buffer.st_size; //Returns the size of the file. Check the manual for more info on stat();
}
char * who_the_fuck_you_are(int hex1, int hex2, int hex3, int hex4, int hex5, int hex6, int hex7, int hex8){

    if (hex1 == 0x4D && hex2 == 0x5A && hex3 == 0x90 && hex4 == 0x00){
        arch_type = 1;
        return "Windows Executable (MS-DOS MZ)";
    } else if (hex1 == 0xCA && hex2 == 0xFE && hex3 == 0xBA && hex4 == 0xBE) {
        if (hex5 == 0x00 && hex6 == 0x00 && hex7 == 0x00 && hex8 == 0x02) {
            number_of_archs = 2;
        }
        arch_type = 2; //The magic matches the Fat Mach-O Executable.
        return "Fat Mach-O File";
    } else {
        arch_type = 0;
        return "Unknown";
    }
}
int main(){
    system("clear");
    char path[512];
    printf("Unicorn Crack-Me Patcher 1.0 by GeoSn0w (@FCE365)\nEDUCATIONAL PURPOSE ONLY!\n");
    printf("\nDrop the Unicorn binary here or specify the path.\n");
    scanf("%s",path); //Get the path
    binary_size = getSize(path); //Get the size of the file using stat()
    unsigned char hex_dump[binary_size];
    FILE *f = fopen(path,"r+"); //Open the file for both reading and writing.
    fread(&hex_dump, 1, binary_size, f);
    who_the_fuck_you_are(hex_dump[0],hex_dump[1],hex_dump[2],hex_dump[3],hex_dump[4],hex_dump[5],hex_dump[6],hex_dump[7]); //Detect the architecture.
    if (arch_type == 2){
      printf("\t[INFO] Parsed FAT Mach-O Executable file with a magic of CA FE BA BE\n");
      printf("\t[INFO] The FAT Mach-O Executable file contains %d structures.\n",number_of_archs);
      printf("\t[INFO] Successfully loaded binary file with size 0x%x\n", binary_size); //File size in HEX
      printf("\t[INFO] That is %d bytes for the HEX haters.\n", binary_size); //File size in bytes.
      fseek(f, 11075 , SEEK_SET); //jnz short loc_2B6E
      printf("\t[INFO] Found conditional jump instruction at offset %ld\n", ftell(f)); //Offset of the instruction to be patched
      printf("\t[INFO] Patching instruction at offset %ld\n", ftell(f));
        char patch[] = {0xEB}; // jmp short loc_2B6E
      fwrite (patch , sizeof(char), sizeof(patch), f); //WE OUT HERE
      fclose (f);
      printf("\t[SUCCESS] Unicorn Crack-Me should now be patched.\n");
      return 0; //Exit
    } else {
      printf("[FAIL] Unknown file type. Not a macOS binary.\n"); //We failed?!
      printf("[FAILED] Unicorn wasn't patched.\n");
      return 1;
    }
}
